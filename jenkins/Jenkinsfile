pipeline {
  agent none
  environment {
    NX_BRANCH = env.BRANCH_NAME.replace('PR-', '');
    BASE_SHA = 'HEAD~1';
    NPMJS_TOKEN = credentials('jenkins-npmjs-token')
  }
  stages {
    stage('Prepare') {
      when { anyOf { branch 'master'; branch 'develop'; branch pattern: "^(hotfix/.*|release/.*|publish_.*)", comparator: 'REGEXP' } }
      agent any
      steps {
        script {
          env.BASE_SHA = env.CHANGE_ID ? 'origin/${env.CHANGE_TARGET}' : 'HEAD~1'
          sh "npm ci"
        }
      }
    }
    stage('Lint') {
      when { anyOf { branch 'master'; branch 'develop'; branch pattern: "^(hotfix/.*|release/.*|publish_.*)", comparator: 'REGEXP' } }
      agent any
      steps {
        script {
          sh "npx nx workspace-lint"
          sh "npx nx affected --base=${BASE_SHA} --target=lint --parallel=3"
        }
      }
    }
    stage('Test') {
      when { anyOf { branch 'master'; branch 'develop'; branch pattern: "^(hotfix/.*|release/.*|publish_.*)", comparator: 'REGEXP' } }
      agent any
      steps {
        script {
          sh "npx nx affected --base=${BASE_SHA} --target=test --parallel=3"
        }
      }
    }
    stage('Build') {
      when { anyOf { branch 'master'; branch 'develop'; branch pattern: "^(hotfix/.*|release/.*)", comparator: 'REGEXP' } }
      agent any
      steps {
        script {
          sh "npx nx affected --base=${BASE_SHA} --target=build --parallel=3"
        }
      }
    }
    stage('Publish - Lib'){
      when { anyOf { branch pattern: "^(publish_.*)", comparator: 'REGEXP' } }
      agent any
      steps{
        script {
          branchName = "${BRANCH_NAME}"
          version = branchName.substring(branchName.indexOf("_"))
          version = version.replace("_", "")
          sh 'echo "//registry.npmjs.org/:_authToken=${NPMJS_TOKEN}" >> ~/.npmrc'
          sh "npx nx affected --base=HEAD~1 --target=publish --ver=${version} --parallel=3"
        }
      }
    }
  }
}


// stage('PR') {
//                     when {
//                         not { branch 'master' || "publish_*" }
//                     }
//                     agent any
//                     steps {
//                       script {
//                         sh "npm ci"
//                         sh "npx nx workspace-lint"
//                         sh "npx nx format:check --base origin/${env.CHANGE_TARGET}"
//                         sh "npx nx affected --base origin/${env.CHANGE_TARGET} --target=lint --parallel=3"
//                         sh "npx nx affected --base origin/${env.CHANGE_TARGET} --target=test --parallel=3 --ci  --code-coverage"
//                         sh "npx nx affected --base origin/${env.CHANGE_TARGET} --target=build --parallel=3"
//                       }
//                     }
//                 }

//                 stage('Publish') {
//                     when {
//                         branch pattern: "^(publish_.*)", comparator: 'REGEXP'
//                     }
//                     agent any
//                     steps {
//                       script {
//                         sh "npm ci"
//                         sh "npx nx workspace-lint"
//                         sh "npx nx format:check --base=HEAD~1"
//                         sh "npx nx affected --base=HEAD~1 --target=lint --parallel=3"
//                         sh "npx nx affected --base=HEAD~1 --target=test --parallel=3"
//                         branchName = "${BRANCH_NAME}"
//                         version = branchName.substring(branchName.indexOf("_"))
//                         version = version.replace("_", "")
//                         sh "npx nx affected --base=HEAD~1 --target=publish --ver=${version} --parallel=3"
//                       }
//                     }
//                 }
